{% macro url(url, text = null) %}
    <a href="{{ url }}">{{ text ?? url }}</a>
{% endmacro %}

{% macro period(startDate, endDate) %}
    {% set startFormat = date(startDate) %}
    {% set endFormat = endDate ? date(endDate) : date() %}
    {% set interval = endFormat.diff(startFormat) %}

    {% set yearLabel = interval.y > 0 ? (interval.y ~ (interval.y > 1 ? ' years' : ' year')) : '' %}

    {% if interval.m > 1 %}
        {% set monthLabel = interval.m ~ ' months' %}
    {% elseif interval.m == 1 or (interval.m == 0 and interval.y == 0) %}
        {% set monthLabel = '1 month' %}
    {% endif %}

    {% set tooltip = startDate ~ ' to ' ~ (endDate ?? "present") %}

    <span data-tooltip="{{ tooltip }}">
        {{ [yearLabel, monthLabel] | filter(v => v) | join(', ') ~ (not endDate ? ' (ongoing)' : '') }}
    </span>
{% endmacro %}

{% macro role(role, attribute) %}
    <article>
        <hgroup>
            <h4>
                {{ role[attribute].name }}
            </h4>
            <p>
                <small>
                    {% if role[attribute].alternateName %}
                        {{ role[attribute].alternateName }} &mdash;
                    {% endif %}
                    {{ role[attribute].location }} &mdash;
                    {{ _self.url(role[attribute].sameAs, "Website") }}
                </small>
            </p>

            {% if role[attribute].description %}
                <p>
                    <small>&#9432; {{ role[attribute].description }}</small>
                </p>
            {% endif %}
        </hgroup>

        <div class="grid">
            <div>
                <p>
                    {% if attribute == "alumniOf" %}
                        <strong>Graduation:</strong> {{ role.startDate }}
                    {% else %}
                        <strong>{{ role.roleName }}</strong> for {{ _self.period(role.startDate, role.endDate) }}
                    {% endif %}
                </p>
                {% if role.alternateName %}
                <p>
                    Additional roles: {{ role.alternateName|join(", ") }}
                </p>
                {% endif %}
            </div>
            {% if role.description %}
            <div>
                <p><em>{{ role.description|nl2br }}</em></p>
            </div>
            {% endif %}
        </div>

        {% if role[attribute].subOrganization %}
            <details>
                <summary role="button" class="secondary outline">Consulting Assignments</summary>
                <table>
                    <tbody>
                    {% for projectRole in role[attribute].subOrganization %}
                        {% set project = projectRole.subOrganization %}
                        <tr>
                            <td>
                                {{ project.sameAs ? _self.url(project.sameAs, project.name) : project.name }}
                                {% if projectRole.numberedPosition > 1 %}
                                    <br>
                                    <small>
                                        {{ projectRole.numberedPosition|format_ordinal_number(locale: 'en') }} tenure
                                    </small>
                                {% endif %}
                            </td>
                            <td>
                                {{ _self.period(projectRole.startDate, projectRole.endDate) }}
                            </td>
                            <td>{{ project.description }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </details>
        {% endif %}
    </article>
{% endmacro %}